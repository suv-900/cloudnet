trigger:
  branches:
    include:
    - main
  paths:
    include:
    - infrastructure/*

parameters:
- name: environment
  type: string
  displayName: Environment
  default: dev
  values:
  - 'dev'
  - 'prod'
  - 'stage'
  - 'qa'

pool: Default

stages:
- stage: 'Validate'
  displayName: 'Terraform validate'
  jobs:
  - job: 
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'azure_service_connection1'
        backendAzureRmResourceGroupName: 'suvham-tfstate-rg'
        backendAzureRmStorageAccountName: 'suvhamtfstatesa'
        backendAzureRmContainerName: 'suvham-tfstate-container'
        backendAzureRmKey: 'dev.tfstate'
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'validate'
    
- stage: 'Plan'
  displayName: 'Plan'
  jobs:
  - job:
    steps:
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'plan'
        commandOptions: '-var-file=.\environments\${{ parameters.environment }}\variables.tfvars'
        environmentServiceNameAzureRM: 'azure_service_connection1'
    

- stage: 'Apply'
  displayName: 'Apply'
  jobs:
  - job:
    steps:
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'apply'
        commandOptions: '-var-file=.\environments\${{ parameters.environment }}\variables.tfvars -auto-approve'
        environmentServiceNameAzureRM: 'azure_service_connection1'


      
